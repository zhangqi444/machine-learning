
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>21. Convolutional Neural Networks &#8212; Machine Learning Open Book</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/drawio.css" />
    <link rel="stylesheet" type="text/css" href="../_static/youtube.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "open-academy/machine-learning-utterances");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "💬 comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script src="https://wavedrom.com/skins/default.js"></script>
    <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="https://cdn.jsdelivr.net/gh/bonartm/quizdown-js@latest/public/build/quizdown.js"></script>
    <script>quizdown.init({"quizdown_js": "https://cdn.jsdelivr.net/gh/bonartm/quizdown-js@latest/public/build/quizdown.js"});</script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="22. Generative adversarial networks" href="GAN.html" />
    <link rel="prev" title="20. Deep learning overview (TBD)" href="dl-overview.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Machine Learning Open Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PREREQUISITES
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../prerequisites/python-programming-introduction.html">
   1. Python programming introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../prerequisites/python-programming-basics.html">
   2. Python programming basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../prerequisites/python-programming-advanced.html">
   3. Python programming advanced
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DATA SCIENCE
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../data-science/introduction/introduction.html">
   4. Introduction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/introduction/defining-data-science.html">
     4.1. Defining data science
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/introduction/data-science-ethics.html">
     4.2. Data Science ethics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/introduction/defining-data.html">
     4.3. Defining data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/introduction/introduction-to-statistics-and-probability.html">
     4.4. Introduction to statistics and probability
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../data-science/working-with-data/working-with-data.html">
   5. Working with data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/working-with-data/relational-databases.html">
     5.1. Relational databases
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/working-with-data/non-relational-data.html">
     5.2. Non-relational data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/working-with-data/numpy.html">
     5.3. NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/working-with-data/pandas.html">
     5.4. Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/working-with-data/data-preparation.html">
     5.5. Data preparation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../data-science/data-visualization/data-visualization.html">
   6. Data visualization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-visualization/visualizing-quantities.html">
     6.1. Visualizing quantities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-visualization/visualization-distributions.html">
     6.2. Visualizing distributions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-visualization/visualization-proportions.html">
     6.3. Visualizing proportions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-visualization/visualization-relationships.html">
     6.4. Visualizing relationships: all about honey 🍯
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-visualization/meaningful-visualizations.html">
     6.5. Making meaningful visualizations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../data-science/data-science-lifecycle/data-science-lifecycle.html">
   7. Data Science lifecycle
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-science-lifecycle/introduction.html">
     7.1. Introduction to the Data Science lifecycle
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-science-lifecycle/analyzing.html">
     7.2. Analyzing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-science-lifecycle/communication.html">
     7.3. Communication
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../data-science/data-science-in-the-cloud/data-science-in-the-cloud.html">
   8. Data Science in the cloud
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-science-in-the-cloud/introduction.html">
     8.1. Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-science-in-the-cloud/the-low-code-no-code-way.html">
     8.2. The “low code/no code” way
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data-science/data-science-in-the-cloud/the-azure-ml-sdk-way.html">
     8.3. Data Science in the cloud: The “Azure ML SDK” way
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data-science/data-science-in-the-wild.html">
   9. Data Science in the real world
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  FUNDAMENTALS OF MACHINE LEARNING
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ml-fundamentals/ml-overview.html">
   10. Machine learning overview
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ml-fundamentals/regression/regression-models-for-machine-learning.html">
   11. Regression models for Machine Learning
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/regression/tools-of-the-trade.html">
     11.1. Tools of the trade
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/regression/managing-data.html">
     11.2. Managing data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/regression/linear-and-polynomial-regression.html">
     11.3. Linear and polynomial regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/regression/logistic-regression.html">
     11.4. Logistic regression
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml-fundamentals/build-a-web-app-to-use-a-machine-learning-model.html">
   12. Build a web app to use a Machine Learning model
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ml-fundamentals/classification/getting-started-with-classification.html">
   13. Getting started with classification
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/classification/introduction-to-classification.html">
     13.1. Introduction to classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/classification/more-classifiers.html">
     13.2. More classifiers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/classification/yet-other-classifiers.html">
     13.3. Yet other classifiers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-fundamentals/classification/applied-ml-build-a-web-app.html">
     13.4. Applied Machine Learning : build a web app
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ADVANCED MACHINE LEARNING
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ml-advanced/clustering/clustering-models-for-machine-learning.html">
   14. Clustering models for Machine Learning
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-advanced/clustering/introduction-to-clustering.html">
     14.1. Introduction to clustering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ml-advanced/clustering/k-means-clustering.html">
     14.2. K-Means clustering
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml-advanced/kernel-method.html">
   15. Kernel method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml-advanced/model-selection.html">
   16. Model selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml-advanced/ensemble-learning.html">
   17. Ensemble learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml-advanced/unsupervised-learning.html">
   18. Unsupervised learning (TBD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml-advanced/generative-models.html">
   19. Generative models
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DEEP LEARNING
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="dl-overview.html">
   20. Deep learning overview (TBD)
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   21. Convolutional Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="GAN.html">
   22. Generative adversarial networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="RNN.html">
   23. Recurrent Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="AutoEncoder.html">
   24. Autoencoder
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="LSTM.html">
   25. Long-short term memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NLP.html">
   26. NLP (TBD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="time-series.html">
   27. Time series (TBD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DQN.html">
   28. DQN (TBD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dl-summary.html">
   29. Summary of deep learning (TBD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="image-classification.html">
   30. Image classification
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MACHINE LEARNING PRODUCTIONIZATION
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../machine-learning-productionization/overview.html">
   31. Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../machine-learning-productionization/problem-framing.html">
   32. Problem framing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../machine-learning-productionization/data-engineering.html">
   33. Data engineering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../machine-learning-productionization/model-training-and-evaluation.html">
   34. Model training &amp; evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../machine-learning-productionization/model-deployment.html">
   35. Model deployment
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  SUPPORTING MATERIALS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../supporting-materials/pytorch.html">
   36. PyTorch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../supporting-materials/bamboolib.html">
   37. Bamboolib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../supporting-materials/mito.html">
   38. Mito
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../supporting-materials/KNN.html">
   39. KNN (TBD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../supporting-materials/semi-supervised-learning.html">
   40. Semi-supervised learning (TBD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../supporting-materials/unbalanced-problems.html">
   41. Unbalanced problems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../supporting-materials/automl.html">
   42. AutoML (TBD)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  OTHERS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../assignments/introduction.html">
   43. Assignments
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/get-started.html">
     43.1. Get started
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/set-up-env/first-assignment.html">
     43.2. First assignment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/set-up-env/second-assignment.html">
     43.3. Second assignment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/project-plan-template.html">
     43.4. Project Plan​ Template
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/prerequisites/python-programming-introduction.html">
     43.5. Python programming introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/prerequisites/python-programming-basics.html">
     43.6. Python programming basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/prerequisites/python-programming-advanced.html">
     43.7. Python programming advanced
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/analyzing-text-about-data-science.html">
     43.8. Analyzing text about Data Science
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/data-science-scenarios.html">
     43.9. Data Science scenarios
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/write-a-data-ethics-case-study.html">
     43.10. Write a data ethics case study
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/lines-scatters-and-bars.html">
     43.11. Lines, scatters and bars
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/apply-your-skills.html">
     43.12. Apply your skills
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/try-it-in-excel.html">
     43.13. Try it in Excel
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/let-us-learn-about-birds.html">
     43.14. Let’s learn about birds
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/bird-distributions.html">
     43.15. Bird distributions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/dive-into-the-beehive.html">
     43.16. Dive into the beehive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/build-your-own-custom-vis.html">
     43.17. Build your own custom vis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/classifying-datasets.html">
     43.18. Classifying datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/small-diabetes-study.html">
     43.19. Small diabetes study
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/introduction-to-statistics-and-probability.html">
     43.20. Introduction to probability and statistics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/displaying-airport-data.html">
     43.21. Displaying airport data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/soda-profits.html">
     43.22. Soda profits
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/analyzing-COVID-19-papers.html">
     43.23. Analyzing COVID-19 papers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/estimation-of-COVID-19-pandemic.html">
     43.24. Estimation of COVID-19 pandemic
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/data-processing-in-python.html">
     43.25. Data processing in Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/evaluating-data-from-a-form.html">
     43.26. Evaluating data from a form
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/data-preparation.html">
     43.27. Data preparation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/analyzing-data.html">
     43.28. Analyzing data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/nyc-taxi-data-in-winter-and-summer.html">
     43.29. NYC taxi data in winter and summer
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/matplotlib-applied.html">
     43.30. Matplotlib applied
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/tell-a-story.html">
     43.36. Tell a story
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/explore-a-planetary-computer-dataset.html">
     43.37. Explore a planetary computer dataset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/exploring-for-anwser.html">
     43.38. Exploring for answers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/market-research.html">
     43.39. Market research
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/low-code-no-code-data-science-project-on-azure-ml.html">
     43.40. Low code/no code Data Science project on Azure ML
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/data-science-project-using-azure-ml-sdk.html">
     43.41. Data Science project using Azure ML SDK
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/data-science/data-science-in-the-cloud-the-azure-ml-sdk-way.html">
     43.42. Data Science in the cloud: The “Azure ML SDK” way
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/ml-overview-iris.html">
     43.43. Machine Learning overview - assignment 1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/ml-overview-mnist-digits.html">
     43.44. Digit Recognizer
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/regression-with-scikit-learn.html">
     43.46. Regression with Scikit-learn
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/regression-tools.html">
     43.47. Regression tools
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/managing-data.html">
     43.48. Managing data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/exploring-visualizations.html">
     43.49. Exploring visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/try-a-different-model.html">
     43.50. Try a different model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/create-a-regression-model.html">
     43.51. Create a regression model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/linear-and-polynomial-regression.html">
     43.52. Linear and polynomial regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/build-classification-models-predict-the-price-range.html">
     43.53. Build classification models：Predict the price range
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/retrying-some-regression.html">
     43.54. Retrying some regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/pumpkin-varieties-and-color.html">
     43.55. Pumpkin varieties and color
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/delicious-asian-and-indian-cuisines.html">
     43.56. Delicious asian and indian cuisines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/explore-classification-methods.html">
     43.57. Explore classification methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-advanced/ensemble-learning/random-forests-intro-and-regression.html">
     43.58. Random forests intro and regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-advanced/ensemble-learning/random-forests-for-classification.html">
     43.59. Random forests for classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-advanced/ensemble-learning/beyond-random-forests-more-ensemble-models.html">
     43.60. Beyond random forests: more ensemble models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/machine-learning-productionization/data-engineering.html">
     43.61. Data engineering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/machine-learning-productionization/counterintuitive-challenges-in-ml-debugging.html">
     43.62. Counterintuitive Challenges in ML Debugging
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/machine-learning-productionization/debugging-in-classification.html">
     43.63. Case Study: Debugging in Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/machine-learning-productionization/debugging-in-regression.html">
     43.64. Case Study: Debugging in Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/study-the-solvers.html">
     43.65. Study the solvers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/build-classification-models.html">
     43.66. Build classification models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/build-classification-model.html">
     43.67. Build Classification Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../assignments/ml-fundamentals/parameter-play.html">
     43.68. Parameter play
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../slides/introduction.html">
   44. Slides
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/python-programming/python-programming-introduction.html">
     44.1. Python programming introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/python-programming/python-programming-basics.html">
     44.2. Python programming basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/python-programming/python-programming-advanced.html">
     44.3. Python programming advanced
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/data-science/data-science-introduction.html">
     44.4. Data Science introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/data-science/relational-vs-non-relational-database.html">
     44.5. Relational vs. non-relational database
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/data-science/numpy-and-pandas.html">
     44.6. NumPy and Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/data-science/data-visualization.html">
     44.7. Data visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/data-science/data-science-lifecycle.html">
     44.8. Data Science lifecycle
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/data-science/data-science-in-the-cloud.html">
     44.9. Data Science in the cloud
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/data-science/data-science-in-real-world.html">
     44.10. Data Science in real world
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../slides/ml-fundamentals/ml-overview.html">
     44.11. Machine Learning overview
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/open-academy/machine-learning/main?urlpath=tree/open-machine-learning-jupyter-book/deep-learning/CNN.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/open-academy/machine-learning/blob/main/open-machine-learning-jupyter-book/deep-learning/CNN.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/open-academy/machine-learning/"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/open-academy/machine-learning//issues/new?title=Issue%20on%20page%20%2Fdeep-learning/CNN.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/open-academy/machine-learning/edit/main/open-machine-learning-jupyter-book/deep-learning/CNN.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/deep-learning/CNN.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="../_sources/deep-learning/CNN.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mnist-handwritten-digits">
   21.1. MNIST handwritten digits
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code">
     21.1.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cifar-10">
   21.2. CIFAR-10
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     21.2.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-to-fine-tune-current-cnn-architectures">
   21.3. How to fine-tune current CNN architectures?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     21.3.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stylenet-neural-style">
   21.4. Stylenet / Neural-Style
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     21.4.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deepdream-in-tensorflow">
   21.5. Deepdream in TensorFlow
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     21.5.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#your-turn">
   21.6. Your turn! 🚀
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#self-study">
   21.7. Self study
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#research-trend">
     21.7.1. Research trend
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgments">
   21.8. Acknowledgments
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Convolutional Neural Networks</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mnist-handwritten-digits">
   21.1. MNIST handwritten digits
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code">
     21.1.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cifar-10">
   21.2. CIFAR-10
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     21.2.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-to-fine-tune-current-cnn-architectures">
   21.3. How to fine-tune current CNN architectures?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     21.3.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stylenet-neural-style">
   21.4. Stylenet / Neural-Style
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     21.4.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deepdream-in-tensorflow">
   21.5. Deepdream in TensorFlow
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     21.5.1. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#your-turn">
   21.6. Your turn! 🚀
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#self-study">
   21.7. Self study
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#research-trend">
     21.7.1. Research trend
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgments">
   21.8. Acknowledgments
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="convolutional-neural-networks">
<h1><span class="section-number">21. </span>Convolutional Neural Networks<a class="headerlink" href="#convolutional-neural-networks" title="Permalink to this headline">#</a></h1>
<blockquote class="epigraph">
<div><p>Thanks to Convolutional Neural Network, computer vision is working far better than just two years ago, and this is enabling numerous exciting applications ranging from safe autonomous driving, to accurate face recognition, to automatic reading of radiology images.</p>
<p class="attribution">—Andrew Ng</p>
</div></blockquote>
<p>Convolutional Neural Networks (CNNs) are responsible for the latest major breakthroughs in image recognition in the past few years.</p>
<p>In mathematics, a convolution is a function that is applied over the output of another function. In our case, we will consider applying a matrix multiplication (filter) across an image. See the below diagram for an example of how this may work.</p>
<figure class="align-default" id="intro-cnn-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/01_intro_cnn.png"><img alt="../_images/01_intro_cnn.png" class="bg-white mb-1" src="../_images/01_intro_cnn.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.1 </span><span class="caption-text">Illustration of matrix mutliplication (filter) in CNN <span id="id1">[<a class="reference internal" href="#id71" title="Wikipedia. Rectifier (neural networks). URL: https://en.wikipedia.org/wiki/Rectifier_(neural_networks)/ (visited on 2022).">Wik</a>]</span></span><a class="headerlink" href="#intro-cnn-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p style="text-align: center;">
<iframe src="../html/conv-demo/index.html" width="105%" height="700px;" style="border:none;"></iframe>
A demo of convolution function. <a href="https://cs231n.github.io/convolutional-networks/">[source]</a>
</p>
<p>CNNs generally follow a structure. The main convolutional setup is (input array) -&gt; (convolutional filter layer) -&gt; (Pooling) -&gt; (Activation layer). The above diagram depicts how a convolutional layer may create one feature. Generally, filters are multidimensional and end up creating many features. It is also common to have a completely separate filter-feature creator of different sizes acting on the same layer. After this convolutional filter, it is common to apply a pooling layer. This pooling may be a max-pooling or an average pooling or another aggregation. One of the key concepts here is that the pooling layer has no parameters while decreasing the layer size. See the below diagram for an example of max-pooling.</p>
<figure class="align-default" id="intro-cnn2-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/01_intro_cnn2.png"><img alt="../_images/01_intro_cnn2.png" class="bg-white mb-1" src="../_images/01_intro_cnn2.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.2 </span><span class="caption-text">Illustration of max pooling</span><a class="headerlink" href="#intro-cnn2-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>After the max pooling, there is generally an activation layer. One of the more common activation layers is the ReLU (Rectified Linear Unit) <span id="id2">[<a class="reference internal" href="#id71" title="Wikipedia. Rectifier (neural networks). URL: https://en.wikipedia.org/wiki/Rectifier_(neural_networks)/ (visited on 2022).">Wik</a>]</span>.</p>
<section id="mnist-handwritten-digits">
<h2><span class="section-number">21.1. </span>MNIST handwritten digits<a class="headerlink" href="#mnist-handwritten-digits" title="Permalink to this headline">#</a></h2>
<p>Here we illustrate how to use a simple CNN with three convolutional units to predict the MNIST handwritten digits.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is good reason why this dataset is used like the ‘hello world’ of image recognition, it is fairly compact while having a decent amount of training, test, and validation data. It only has one channel (black and white) and only ten possible outputs (0-9).</p>
</div>
<p>When the script is done training the model, you should see similar output to the following graphs.</p>
<figure class="align-default" id="cnn1-loss-acc-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/02_cnn1_loss_acc.png"><img alt="../_images/02_cnn1_loss_acc.png" class="bg-white mb-1" src="../_images/02_cnn1_loss_acc.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.3 </span><span class="caption-text">Train MINIST dataset with CNN: accuracy and loss</span><a class="headerlink" href="#cnn1-loss-acc-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Training and test loss (left) and test batch accuracy (right).</p>
<figure class="align-default" id="cnn1-mnist-output-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/02_cnn1_mnist_output.png"><img alt="../_images/02_cnn1_mnist_output.png" class="bg-white mb-1" src="../_images/02_cnn1_mnist_output.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.4 </span><span class="caption-text">Train MINIST dataset with CNN: prediction output</span><a class="headerlink" href="#cnn1-mnist-output-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>A random set of 6 digits with actual and predicted labels. You can see a prediction failure in the lower right box.</p>
<section id="code">
<h3><span class="section-number">21.1.1. </span>Code<a class="headerlink" href="#code" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example, we will download the MNIST handwritten</span>
<span class="c1"># digits and create a simple CNN network to predict the</span>
<span class="c1"># digit category (0-9)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.examples.tutorials.mnist</span> <span class="kn">import</span> <span class="n">input_data</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="n">ops</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>

<span class="c1"># Start a graph session</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="c1"># Load data</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;temp&#39;</span>
<span class="n">mnist</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">read_data_sets</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">one_hot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Convert images into 28x28 (they are downloaded as 1x784)</span>
<span class="n">train_xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mnist</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">images</span><span class="p">])</span>
<span class="n">test_xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mnist</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">images</span><span class="p">])</span>

<span class="c1"># Convert labels into one-hot encoded vectors</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">labels</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">labels</span>

<span class="c1"># Set model parameters</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">evaluation_size</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">image_width</span> <span class="o">=</span> <span class="n">train_xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">image_height</span> <span class="o">=</span> <span class="n">train_xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">target_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">num_channels</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># greyscale = 1 channel</span>
<span class="n">generations</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">eval_every</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">conv1_features</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">conv2_features</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">max_pool_size1</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># NxN window for 1st max pool layer</span>
<span class="n">max_pool_size2</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># NxN window for 2nd max pool layer</span>
<span class="n">fully_connected_size1</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Declare model placeholders</span>
<span class="n">x_input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">)</span>
<span class="n">x_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">x_input_shape</span><span class="p">)</span>
<span class="n">y_target</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>
<span class="n">eval_input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">evaluation_size</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">)</span>
<span class="n">eval_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">eval_input_shape</span><span class="p">)</span>
<span class="n">eval_target</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">evaluation_size</span><span class="p">))</span>

<span class="c1"># Declare model parameters</span>
<span class="n">conv1_weight</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">conv1_features</span><span class="p">],</span>
                                               <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">conv1_bias</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">conv1_features</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="n">conv2_weight</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">conv1_features</span><span class="p">,</span> <span class="n">conv2_features</span><span class="p">],</span>
                                               <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">conv2_bias</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">conv2_features</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="c1"># fully connected variables</span>
<span class="n">resulting_width</span> <span class="o">=</span> <span class="n">image_width</span> <span class="o">//</span> <span class="p">(</span><span class="n">max_pool_size1</span> <span class="o">*</span> <span class="n">max_pool_size2</span><span class="p">)</span>
<span class="n">resulting_height</span> <span class="o">=</span> <span class="n">image_height</span> <span class="o">//</span> <span class="p">(</span><span class="n">max_pool_size1</span> <span class="o">*</span> <span class="n">max_pool_size2</span><span class="p">)</span>
<span class="n">full1_input_size</span> <span class="o">=</span> <span class="n">resulting_width</span> <span class="o">*</span> <span class="n">resulting_height</span> <span class="o">*</span> <span class="n">conv2_features</span>
<span class="n">full1_weight</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="n">full1_input_size</span><span class="p">,</span> <span class="n">fully_connected_size1</span><span class="p">],</span>
                           <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">full1_bias</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="n">fully_connected_size1</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">full2_weight</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="n">fully_connected_size1</span><span class="p">,</span> <span class="n">target_size</span><span class="p">],</span>
                                               <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">full2_bias</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="n">target_size</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>


<span class="c1"># Initialize Model Operations</span>
<span class="k">def</span> <span class="nf">my_conv_net</span><span class="p">(</span><span class="n">conv_input_data</span><span class="p">):</span>
    <span class="c1"># First Conv-ReLU-MaxPool Layer</span>
    <span class="n">conv1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">conv_input_data</span><span class="p">,</span> <span class="n">conv1_weight</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">)</span>
    <span class="n">relu1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">conv1</span><span class="p">,</span> <span class="n">conv1_bias</span><span class="p">))</span>
    <span class="n">max_pool1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">relu1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_pool_size1</span><span class="p">,</span> <span class="n">max_pool_size1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                               <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_pool_size1</span><span class="p">,</span> <span class="n">max_pool_size1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">)</span>

    <span class="c1"># Second Conv-ReLU-MaxPool Layer</span>
    <span class="n">conv2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">max_pool1</span><span class="p">,</span> <span class="n">conv2_weight</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">)</span>
    <span class="n">relu2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">conv2</span><span class="p">,</span> <span class="n">conv2_bias</span><span class="p">))</span>
    <span class="n">max_pool2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">relu2</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_pool_size2</span><span class="p">,</span> <span class="n">max_pool_size2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                               <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_pool_size2</span><span class="p">,</span> <span class="n">max_pool_size2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">)</span>

    <span class="c1"># Transform Output into a 1xN layer for next fully connected layer</span>
    <span class="n">final_conv_shape</span> <span class="o">=</span> <span class="n">max_pool2</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
    <span class="n">final_shape</span> <span class="o">=</span> <span class="n">final_conv_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">final_conv_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">final_conv_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">flat_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">max_pool2</span><span class="p">,</span> <span class="p">[</span><span class="n">final_conv_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_shape</span><span class="p">])</span>

    <span class="c1"># First Fully Connected Layer</span>
    <span class="n">fully_connected1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">flat_output</span><span class="p">,</span> <span class="n">full1_weight</span><span class="p">),</span> <span class="n">full1_bias</span><span class="p">))</span>

    <span class="c1"># Second Fully Connected Layer</span>
    <span class="n">final_model_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">fully_connected1</span><span class="p">,</span> <span class="n">full2_weight</span><span class="p">),</span> <span class="n">full2_bias</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">final_model_output</span>

<span class="n">model_output</span> <span class="o">=</span> <span class="n">my_conv_net</span><span class="p">(</span><span class="n">x_input</span><span class="p">)</span>
<span class="n">test_model_output</span> <span class="o">=</span> <span class="n">my_conv_net</span><span class="p">(</span><span class="n">eval_input</span><span class="p">)</span>

<span class="c1"># Declare Loss Function (softmax cross entropy)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">model_output</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">y_target</span><span class="p">))</span>

<span class="c1"># Create a prediction function</span>
<span class="n">prediction</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model_output</span><span class="p">)</span>
<span class="n">test_prediction</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">test_model_output</span><span class="p">)</span>


<span class="c1"># Create accuracy function</span>
<span class="k">def</span> <span class="nf">get_accuracy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="n">batch_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">num_correct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">batch_predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">))</span>
    <span class="k">return</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">num_correct</span><span class="o">/</span><span class="n">batch_predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Create an optimizer</span>
<span class="n">my_optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">train_step</span> <span class="o">=</span> <span class="n">my_optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

<span class="c1"># Initialize Variables</span>
<span class="n">init</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
<span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>

<span class="c1"># Start training loop</span>
<span class="n">train_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">generations</span><span class="p">):</span>
    <span class="n">rand_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_xdata</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">rand_x</span> <span class="o">=</span> <span class="n">train_xdata</span><span class="p">[</span><span class="n">rand_index</span><span class="p">]</span>
    <span class="n">rand_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">rand_x</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">rand_y</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="n">rand_index</span><span class="p">]</span>
    <span class="n">train_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_input</span><span class="p">:</span> <span class="n">rand_x</span><span class="p">,</span> <span class="n">y_target</span><span class="p">:</span> <span class="n">rand_y</span><span class="p">}</span>
    
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">train_dict</span><span class="p">)</span>
    <span class="n">temp_train_loss</span><span class="p">,</span> <span class="n">temp_train_preds</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">loss</span><span class="p">,</span> <span class="n">prediction</span><span class="p">],</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">train_dict</span><span class="p">)</span>
    <span class="n">temp_train_acc</span> <span class="o">=</span> <span class="n">get_accuracy</span><span class="p">(</span><span class="n">temp_train_preds</span><span class="p">,</span> <span class="n">rand_y</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">eval_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">eval_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_xdata</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">evaluation_size</span><span class="p">)</span>
        <span class="n">eval_x</span> <span class="o">=</span> <span class="n">test_xdata</span><span class="p">[</span><span class="n">eval_index</span><span class="p">]</span>
        <span class="n">eval_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">eval_x</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">eval_y</span> <span class="o">=</span> <span class="n">test_labels</span><span class="p">[</span><span class="n">eval_index</span><span class="p">]</span>
        <span class="n">test_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">eval_input</span><span class="p">:</span> <span class="n">eval_x</span><span class="p">,</span> <span class="n">eval_target</span><span class="p">:</span> <span class="n">eval_y</span><span class="p">}</span>
        <span class="n">test_preds</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">test_prediction</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">test_dict</span><span class="p">)</span>
        <span class="n">temp_test_acc</span> <span class="o">=</span> <span class="n">get_accuracy</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">eval_y</span><span class="p">)</span>
        
        <span class="c1"># Record and print results</span>
        <span class="n">train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_train_loss</span><span class="p">)</span>
        <span class="n">train_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_train_acc</span><span class="p">)</span>
        <span class="n">test_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_test_acc</span><span class="p">)</span>
        <span class="n">acc_and_loss</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">temp_train_loss</span><span class="p">,</span> <span class="n">temp_train_acc</span><span class="p">,</span> <span class="n">temp_test_acc</span><span class="p">]</span>
        <span class="n">acc_and_loss</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">acc_and_loss</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generation # </span><span class="si">{}</span><span class="s1">. Train Loss: </span><span class="si">{:.2f}</span><span class="s1">. Train Acc (Test Acc): </span><span class="si">{:.2f}</span><span class="s1"> (</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">acc_and_loss</span><span class="p">))</span>
    
    
<span class="c1"># Matlotlib code to plot the loss and accuracies</span>
<span class="n">eval_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">generations</span><span class="p">,</span> <span class="n">eval_every</span><span class="p">)</span>
<span class="c1"># Plot loss over time</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eval_indices</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Softmax Loss per Generation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Generation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Softmax Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot train and test accuracy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eval_indices</span><span class="p">,</span> <span class="n">train_acc</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Set Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eval_indices</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Set Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train and Test Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Generation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot some samples</span>
<span class="c1"># Plot the 6 of the last batch results:</span>
<span class="n">actuals</span> <span class="o">=</span> <span class="n">rand_y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">temp_train_preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rand_x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>

<span class="n">Nrows</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">Ncols</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">Nrows</span><span class="p">,</span> <span class="n">Ncols</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Actual: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actuals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Pred: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
              <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">frame</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">frame</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="cifar-10">
<h2><span class="section-number">21.2. </span>CIFAR-10<a class="headerlink" href="#cifar-10" title="Permalink to this headline">#</a></h2>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Alex Krizhevsky, Vinod Nair, and Geoffrey Hinton. <a class="reference external" href="https://www.cs.toronto.edu/~kriz/cifar.html">CIFAR-10 and CIFAR-100 datasets</a>.</p>
</div>
<p>Here we will build a convolutional neural network to predict the <code class="docutils literal notranslate"><span class="pre">CIFAR-10</span></code> data.</p>
<p>The script provided will download and unzip the <code class="docutils literal notranslate"><span class="pre">CIFAR-10</span></code> data. Then it will start training a CNN from scratch. You should see similar output at the end of the following two graphs.</p>
<figure class="align-default" id="cnn2-loss-acc-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/03_cnn2_loss_acc.png"><img alt="../_images/03_cnn2_loss_acc.png" class="bg-white mb-1" src="../_images/03_cnn2_loss_acc.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.5 </span><span class="caption-text">Train <code class="docutils literal notranslate"><span class="pre">CIFAR-10</span></code> dataset with CNN: accuracy and loss</span><a class="headerlink" href="#cnn2-loss-acc-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Here we see the training loss (left) and the test batch accuracy (right).</p>
<section id="id3">
<h3><span class="section-number">21.2.1. </span>Code<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this example, we will download the CIFAR-10 images</span>
<span class="c1"># and build a CNN model with dropout and regularization</span>
<span class="c1">#</span>
<span class="c1"># CIFAR is composed ot 50k train and 10k test</span>
<span class="c1"># images that are 32x32.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">urllib</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="n">ops</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>

<span class="c1"># Change Directory</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">dname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>

<span class="c1"># Start a graph session</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="c1"># Set model parameters</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;temp&#39;</span>
<span class="n">output_every</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">generations</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">eval_every</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">image_height</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">image_width</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">crop_height</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">crop_width</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">num_channels</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_targets</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">extract_folder</span> <span class="o">=</span> <span class="s1">&#39;cifar-10-batches-bin&#39;</span>

<span class="c1"># Exponential Learning Rate Decay Params</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">lr_decay</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">num_gens_to_wait</span> <span class="o">=</span> <span class="mf">250.</span>

<span class="c1"># Extract model parameters</span>
<span class="n">image_vec_length</span> <span class="o">=</span> <span class="n">image_height</span> <span class="o">*</span> <span class="n">image_width</span> <span class="o">*</span> <span class="n">num_channels</span>
<span class="n">record_length</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">image_vec_length</span> <span class="c1"># ( + 1 for the 0-9 label)</span>

<span class="c1"># Load data</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;temp&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="n">cifar10_url</span> <span class="o">=</span> <span class="s1">&#39;http://www.cs.toronto.edu/~kriz/cifar-10-binary.tar.gz&#39;</span>

<span class="c1"># Check if file exists, otherwise download it</span>
<span class="n">data_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;cifar-10-binary.tar.gz&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Download file</span>
    <span class="k">def</span> <span class="nf">progress</span><span class="p">(</span><span class="n">block_num</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">total_size</span><span class="p">):</span>
        <span class="n">progress_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">cifar10_url</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">block_num</span> <span class="o">*</span> <span class="n">block_size</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1"> Downloading </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{:.2f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">progress_info</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">filepath</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">cifar10_url</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>
    <span class="c1"># Extract file</span>
    <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r:gz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    

<span class="c1"># Define CIFAR reader</span>
<span class="k">def</span> <span class="nf">read_cifar_files</span><span class="p">(</span><span class="n">filename_queue</span><span class="p">,</span> <span class="n">distort_images</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLengthRecordReader</span><span class="p">(</span><span class="n">record_bytes</span><span class="o">=</span><span class="n">record_length</span><span class="p">)</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">record_string</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename_queue</span><span class="p">)</span>
    <span class="n">record_bytes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">decode_raw</span><span class="p">(</span><span class="n">record_string</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">image_label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">record_bytes</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
  
    <span class="c1"># Extract image</span>
    <span class="n">image_extracted</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">record_bytes</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">image_vec_length</span><span class="p">]),</span>
                                 <span class="p">[</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">])</span>
    
    <span class="c1"># Reshape image</span>
    <span class="n">image_uint8image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image_extracted</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">reshaped_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image_uint8image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># Randomly Crop image</span>
    <span class="n">final_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_image_with_crop_or_pad</span><span class="p">(</span><span class="n">reshaped_image</span><span class="p">,</span> <span class="n">crop_width</span><span class="p">,</span> <span class="n">crop_height</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">distort_images</span><span class="p">:</span>
        <span class="c1"># Randomly flip the image horizontally, change the brightness and contrast</span>
        <span class="n">final_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_flip_left_right</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>
        <span class="n">final_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_brightness</span><span class="p">(</span><span class="n">final_image</span><span class="p">,</span><span class="n">max_delta</span><span class="o">=</span><span class="mi">63</span><span class="p">)</span>
        <span class="n">final_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_contrast</span><span class="p">(</span><span class="n">final_image</span><span class="p">,</span><span class="n">lower</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">1.8</span><span class="p">)</span>

    <span class="c1"># Normalize whitening</span>
    <span class="n">final_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">per_image_standardization</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_image</span><span class="p">,</span> <span class="n">image_label</span>


<span class="c1"># Create a CIFAR image pipeline from reader</span>
<span class="k">def</span> <span class="nf">input_pipeline</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">train_logical</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">train_logical</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">extract_folder</span><span class="p">,</span> <span class="s1">&#39;data_batch_</span><span class="si">{}</span><span class="s1">.bin&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">extract_folder</span><span class="p">,</span> <span class="s1">&#39;test_batch.bin&#39;</span><span class="p">)]</span>
    <span class="n">filename_queue</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">string_input_producer</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">read_cifar_files</span><span class="p">(</span><span class="n">filename_queue</span><span class="p">)</span>
    
    <span class="c1"># min_after_dequeue defines how big a buffer we will randomly sample</span>
    <span class="c1">#   from -- bigger means better shuffling but slower start up and more</span>
    <span class="c1">#   memory used.</span>
    <span class="c1"># capacity must be larger than min_after_dequeue and the amount larger</span>
    <span class="c1">#   determines the maximum we will prefetch.  Recommendation:</span>
    <span class="c1">#   min_after_dequeue + (num_threads + a small safety margin) * batch_size</span>
    <span class="n">min_after_dequeue</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="n">capacity</span> <span class="o">=</span> <span class="n">min_after_dequeue</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">batch_size</span>
    <span class="n">example_batch</span><span class="p">,</span> <span class="n">label_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">shuffle_batch</span><span class="p">([</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">],</span>
                                                        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                                        <span class="n">capacity</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                                                        <span class="n">min_after_dequeue</span><span class="o">=</span><span class="n">min_after_dequeue</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">example_batch</span><span class="p">,</span> <span class="n">label_batch</span>

    
<span class="c1"># Define the model architecture, this will return logits from images</span>
<span class="k">def</span> <span class="nf">cifar_cnn_model</span><span class="p">(</span><span class="n">input_images</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">train_logical</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">truncated_normal_var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">zero_var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)))</span>
    
    <span class="c1"># First Convolutional Layer</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;conv1&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
        <span class="c1"># Conv_kernel is 5x5 for all 3 colors and we will create 64 features</span>
        <span class="n">conv1_kernel</span> <span class="o">=</span> <span class="n">truncated_normal_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_kernel1&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># We convolve across the image with a stride size of 1</span>
        <span class="n">conv1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">input_images</span><span class="p">,</span> <span class="n">conv1_kernel</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">)</span>
        <span class="c1"># Initialize and add the bias term</span>
        <span class="n">conv1_bias</span> <span class="o">=</span> <span class="n">zero_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_bias1&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">conv1_add_bias</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">conv1</span><span class="p">,</span> <span class="n">conv1_bias</span><span class="p">)</span>
        <span class="c1"># ReLU element wise</span>
        <span class="n">relu_conv1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">conv1_add_bias</span><span class="p">)</span>
    
    <span class="c1"># Max Pooling</span>
    <span class="n">pool1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">relu_conv1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pool_layer1&#39;</span><span class="p">)</span>
    
    <span class="c1"># Local Response Normalization (parameters from paper)</span>
    <span class="c1"># paper: http://papers.nips.cc/paper/4824-imagenet-classification-with-deep-convolutional-neural-networks</span>
    <span class="n">norm1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">lrn</span><span class="p">(</span><span class="n">pool1</span><span class="p">,</span> <span class="n">depth_radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;norm1&#39;</span><span class="p">)</span>

    <span class="c1"># Second Convolutional Layer</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;conv2&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
        <span class="c1"># Conv kernel is 5x5, across all prior 64 features and we create 64 more features</span>
        <span class="n">conv2_kernel</span> <span class="o">=</span> <span class="n">truncated_normal_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_kernel2&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># Convolve filter across prior output with stride size of 1</span>
        <span class="n">conv2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">norm1</span><span class="p">,</span> <span class="n">conv2_kernel</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">)</span>
        <span class="c1"># Initialize and add the bias</span>
        <span class="n">conv2_bias</span> <span class="o">=</span> <span class="n">zero_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_bias2&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">conv2_add_bias</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">conv2</span><span class="p">,</span> <span class="n">conv2_bias</span><span class="p">)</span>
        <span class="c1"># ReLU element wise</span>
        <span class="n">relu_conv2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">conv2_add_bias</span><span class="p">)</span>
    
    <span class="c1"># Max Pooling</span>
    <span class="n">pool2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">relu_conv2</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pool_layer2&#39;</span><span class="p">)</span>    
    
     <span class="c1"># Local Response Normalization (parameters from paper)</span>
    <span class="n">norm2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">lrn</span><span class="p">(</span><span class="n">pool2</span><span class="p">,</span> <span class="n">depth_radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;norm2&#39;</span><span class="p">)</span>
    
    <span class="c1"># Reshape output into a single matrix for multiplication for the fully connected layers</span>
    <span class="n">reshaped_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">norm2</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">reshaped_dim</span> <span class="o">=</span> <span class="n">reshaped_output</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    
    <span class="c1"># First Fully Connected Layer</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;full1&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
        <span class="c1"># Fully connected layer will have 384 outputs.</span>
        <span class="n">full_weight1</span> <span class="o">=</span> <span class="n">truncated_normal_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;full_mult1&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">reshaped_dim</span><span class="p">,</span> <span class="mi">384</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">full_bias1</span> <span class="o">=</span> <span class="n">zero_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;full_bias1&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">384</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">full_layer1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">reshaped_output</span><span class="p">,</span> <span class="n">full_weight1</span><span class="p">),</span> <span class="n">full_bias1</span><span class="p">))</span>

    <span class="c1"># Second Fully Connected Layer</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;full2&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
        <span class="c1"># Second fully connected layer has 192 outputs.</span>
        <span class="n">full_weight2</span> <span class="o">=</span> <span class="n">truncated_normal_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;full_mult2&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">384</span><span class="p">,</span> <span class="mi">192</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">full_bias2</span> <span class="o">=</span> <span class="n">zero_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;full_bias2&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">192</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">full_layer2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">full_layer1</span><span class="p">,</span> <span class="n">full_weight2</span><span class="p">),</span> <span class="n">full_bias2</span><span class="p">))</span>

    <span class="c1"># Final Fully Connected Layer -&gt; 10 categories for output (num_targets)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;full3&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
        <span class="c1"># Final fully connected layer has 10 (num_targets) outputs.</span>
        <span class="n">full_weight3</span> <span class="o">=</span> <span class="n">truncated_normal_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;full_mult3&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">full_bias3</span> <span class="o">=</span>  <span class="n">zero_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;full_bias3&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">num_targets</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">final_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">full_layer2</span><span class="p">,</span> <span class="n">full_weight3</span><span class="p">),</span> <span class="n">full_bias3</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">final_output</span>


<span class="c1"># Loss function</span>
<span class="k">def</span> <span class="nf">cifar_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="c1"># Get rid of extra dimensions and cast targets into integers</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="c1"># Calculate cross entropy from logits and targets</span>
    <span class="n">cross_entropy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">targets</span><span class="p">)</span>
    <span class="c1"># Take the average loss across batch size</span>
    <span class="n">cross_entropy_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cross_entropy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cross_entropy_mean</span>


<span class="c1"># Train step</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">loss_value</span><span class="p">,</span> <span class="n">generation_num</span><span class="p">):</span>
    <span class="c1"># Our learning rate is an exponential decay after we wait a fair number of generations</span>
    <span class="n">model_learning_rate</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">exponential_decay</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">generation_num</span><span class="p">,</span>
                                                     <span class="n">num_gens_to_wait</span><span class="p">,</span> <span class="n">lr_decay</span><span class="p">,</span> <span class="n">staircase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Create optimizer</span>
    <span class="n">my_optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">GradientDescentOptimizer</span><span class="p">(</span><span class="n">model_learning_rate</span><span class="p">)</span>
    <span class="c1"># Initialize train step</span>
    <span class="n">train_step</span> <span class="o">=</span> <span class="n">my_optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_step</span>


<span class="c1"># Accuracy function</span>
<span class="k">def</span> <span class="nf">accuracy_of_batch</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="c1"># Make sure targets are integers and drop extra dimensions</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="c1"># Get predicted values by finding which logit is the greatest</span>
    <span class="n">batch_predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="c1"># Check if they are equal across the batch</span>
    <span class="n">predicted_correctly</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">batch_predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
    <span class="c1"># Average the 1&#39;s and 0&#39;s (True&#39;s and False&#39;s) across the batch size</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">predicted_correctly</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">accuracy</span>

<span class="c1"># Get data</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Getting/Transforming Data.&#39;</span><span class="p">)</span>
<span class="c1"># Initialize the data pipeline</span>
<span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">input_pipeline</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">train_logical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Get batch test images and targets from pipline</span>
<span class="n">test_images</span><span class="p">,</span> <span class="n">test_targets</span> <span class="o">=</span> <span class="n">input_pipeline</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">train_logical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Declare Model</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating the CIFAR10 Model.&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;model_definition&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
    <span class="c1"># Declare the training network model</span>
    <span class="n">model_output</span> <span class="o">=</span> <span class="n">cifar_cnn_model</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="c1"># This is very important!!!  We must set the scope to REUSE the variables,</span>
    <span class="c1">#  otherwise, when we set the test network model, it will create new random</span>
    <span class="c1">#  variables.  Otherwise we get random evaluations on the test batches.</span>
    <span class="n">scope</span><span class="o">.</span><span class="n">reuse_variables</span><span class="p">()</span>
    <span class="n">test_output</span> <span class="o">=</span> <span class="n">cifar_cnn_model</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

<span class="c1"># Declare loss function</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Declare Loss Function.&#39;</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">cifar_loss</span><span class="p">(</span><span class="n">model_output</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

<span class="c1"># Create accuracy function</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_of_batch</span><span class="p">(</span><span class="n">test_output</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">)</span>

<span class="c1"># Create training operations</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating the Training Operation.&#39;</span><span class="p">)</span>
<span class="n">generation_num</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">train_op</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">generation_num</span><span class="p">)</span>

<span class="c1"># Initialize Variables</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing the Variables.&#39;</span><span class="p">)</span>
<span class="n">init</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
<span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>

<span class="c1"># Initialize queue (This queue will feed into the model, so no placeholders necessary)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">start_queue_runners</span><span class="p">(</span><span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">)</span>

<span class="c1"># Train CIFAR Model</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting Training&#39;</span><span class="p">)</span>
<span class="n">train_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">generations</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">loss_value</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">train_op</span><span class="p">,</span> <span class="n">loss</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">output_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_value</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;Generation </span><span class="si">{}</span><span class="s1">: Loss = </span><span class="si">{:.5f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">loss_value</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">eval_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="p">[</span><span class="n">temp_accuracy</span><span class="p">]</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">accuracy</span><span class="p">])</span>
        <span class="n">test_accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_accuracy</span><span class="p">)</span>
        <span class="n">acc_output</span> <span class="o">=</span> <span class="s1">&#39; --- Test Accuracy = </span><span class="si">{:.2f}</span><span class="s1">%.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">100.</span><span class="o">*</span><span class="n">temp_accuracy</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">acc_output</span><span class="p">)</span>

<span class="c1"># Print loss and accuracy</span>
<span class="c1"># Matlotlib code to plot the loss and accuracies</span>
<span class="n">eval_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">generations</span><span class="p">,</span> <span class="n">eval_every</span><span class="p">)</span>
<span class="n">output_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">generations</span><span class="p">,</span> <span class="n">output_every</span><span class="p">)</span>

<span class="c1"># Plot loss over time</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_indices</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Softmax Loss per Generation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Generation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Softmax Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot accuracy over time</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eval_indices</span><span class="p">,</span> <span class="n">test_accuracy</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Generation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="how-to-fine-tune-current-cnn-architectures">
<h2><span class="section-number">21.3. </span>How to fine-tune current CNN architectures?<a class="headerlink" href="#how-to-fine-tune-current-cnn-architectures" title="Permalink to this headline">#</a></h2>
<p>The purpose of the script provided in this section is to download the CIFAR-10 data and sort it out in the proper folder structure for running it through the TensorFlow fine-tuning tutorial. The script should create the following folder structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">train_dir</span>
  <span class="o">|--</span><span class="n">airplane</span>
  <span class="o">|--</span><span class="n">automobile</span>
  <span class="o">|--</span><span class="n">bird</span>
  <span class="o">|--</span><span class="n">cat</span>
  <span class="o">|--</span><span class="n">deer</span>
  <span class="o">|--</span><span class="n">dog</span>
  <span class="o">|--</span><span class="n">frog</span>
  <span class="o">|--</span><span class="n">horse</span>
  <span class="o">|--</span><span class="n">ship</span>
  <span class="o">|--</span><span class="n">truck</span>
<span class="o">-</span><span class="n">validation_dir</span>
  <span class="o">|--</span><span class="n">airplane</span>
  <span class="o">|--</span><span class="n">automobile</span>
  <span class="o">|--</span><span class="n">bird</span>
  <span class="o">|--</span><span class="n">cat</span>
  <span class="o">|--</span><span class="n">deer</span>
  <span class="o">|--</span><span class="n">dog</span>
  <span class="o">|--</span><span class="n">frog</span>
  <span class="o">|--</span><span class="n">horse</span>
  <span class="o">|--</span><span class="n">ship</span>
  <span class="o">|--</span><span class="n">truck</span>
</pre></div>
</div>
</div>
</div>
<section id="id4">
<h3><span class="section-number">21.3.1. </span>Code<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In this script, we download the CIFAR-10 images and</span>
<span class="c1"># transform/save them in the Inception Retraining Format</span>
<span class="c1">#</span>
<span class="c1"># The end purpose of the files is for re-training the</span>
<span class="c1"># Google Inception tensorflow model to work on the CIFAR-10.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">_pickle</span> <span class="k">as</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">scipy.misc</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="n">ops</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>

<span class="n">cifar_link</span> <span class="o">=</span> <span class="s1">&#39;https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz&#39;</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;temp&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

<span class="c1"># Download tar file</span>
<span class="n">target_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;cifar-10-python.tar.gz&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">target_file</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CIFAR-10 file not found. Downloading CIFAR data (Size = 163MB)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This may take a few minutes, please wait.&#39;</span><span class="p">)</span>
    <span class="n">filename</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">cifar_link</span><span class="p">,</span> <span class="n">target_file</span><span class="p">)</span>

<span class="c1"># Extract into memory</span>
<span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>
<span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
<span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;airplane&#39;</span><span class="p">,</span> <span class="s1">&#39;automobile&#39;</span><span class="p">,</span> <span class="s1">&#39;bird&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;deer&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;frog&#39;</span><span class="p">,</span> <span class="s1">&#39;horse&#39;</span><span class="p">,</span> <span class="s1">&#39;ship&#39;</span><span class="p">,</span> <span class="s1">&#39;truck&#39;</span><span class="p">]</span>

<span class="c1"># Create train image folders</span>
<span class="n">train_folder</span> <span class="o">=</span> <span class="s1">&#39;train_dir&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">train_folder</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">train_folder</span><span class="p">,</span> <span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
<span class="c1"># Create test image folders</span>
<span class="n">test_folder</span> <span class="o">=</span> <span class="s1">&#39;validation_dir&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">test_folder</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">test_folder</span><span class="p">,</span> <span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

<span class="c1"># Extract images accordingly</span>
<span class="n">data_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;cifar-10-batches-py&#39;</span><span class="p">)</span>
<span class="n">train_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data_batch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">test_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_batch&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">load_batch_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">file_conn</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">image_dictionary</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_conn</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
    <span class="n">file_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">image_dictionary</span>


<span class="k">def</span> <span class="nf">save_images_from_dict</span><span class="p">(</span><span class="n">image_dict</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;data_dir&#39;</span><span class="p">):</span>
    <span class="c1"># image_dict.keys() = &#39;labels&#39;, &#39;filenames&#39;, &#39;data&#39;, &#39;batch_label&#39;</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]):</span>
        <span class="n">folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">objects</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">image_dict</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span>
        <span class="c1">#Transform image data</span>
        <span class="n">image_array</span> <span class="o">=</span> <span class="n">image_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">image_array</span><span class="o">.</span><span class="n">resize</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">])</span>
        <span class="c1"># Save image</span>
        <span class="n">output_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">output_location</span><span class="p">,</span><span class="n">image_array</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

<span class="c1"># Sort train images</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">train_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving images from file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
    <span class="n">file_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;cifar-10-batches-py&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">image_dict</span> <span class="o">=</span> <span class="n">load_batch_from_file</span><span class="p">(</span><span class="n">file_location</span><span class="p">)</span>
    <span class="n">save_images_from_dict</span><span class="p">(</span><span class="n">image_dict</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">train_folder</span><span class="p">)</span>

<span class="c1"># Sort test images</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">test_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving images from file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
    <span class="n">file_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;cifar-10-batches-py&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">image_dict</span> <span class="o">=</span> <span class="n">load_batch_from_file</span><span class="p">(</span><span class="n">file_location</span><span class="p">)</span>
    <span class="n">save_images_from_dict</span><span class="p">(</span><span class="n">image_dict</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">test_folder</span><span class="p">)</span>
    
<span class="c1"># Create labels file</span>
<span class="n">cifar_labels_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="s1">&#39;cifar10_labels.txt&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing labels file, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cifar_labels_file</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cifar_labels_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels_file</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
        <span class="n">labels_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="stylenet-neural-style">
<h2><span class="section-number">21.4. </span>Stylenet / Neural-Style<a class="headerlink" href="#stylenet-neural-style" title="Permalink to this headline">#</a></h2>
<p>The purpose of this script is to illustrate how to do stylenet in TensorFlow. We reference the following <a class="reference external" href="https://arxiv.org/abs/1508.06576">paper</a> for this algorithm.</p>
<p>But there is some prerequisites,</p>
<ul class="simple">
<li><p>Download the <code class="docutils literal notranslate"><span class="pre">VGG-verydeep-19.mat</span></code> file.</p></li>
<li><p>You must download two images, a style image and a content image for the algorithm to blend.</p></li>
</ul>
<p>The style image is</p>
<figure class="align-default" id="starry-night-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/starry_night.jpg"><img alt="../_images/starry_night.jpg" class="bg-white mb-1" src="../_images/starry_night.jpg" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.6 </span><span class="caption-text">Style image: starry night</span><a class="headerlink" href="#starry-night-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The context image is below.</p>
<figure class="align-default" id="book-cover-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/book_cover.jpg"><img alt="../_images/book_cover.jpg" class="bg-white mb-1" src="../_images/book_cover.jpg" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.7 </span><span class="caption-text">Content image: book cover</span><a class="headerlink" href="#book-cover-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The final result looks like</p>
<figure class="align-default" id="stylenet-ex-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/05_stylenet_ex.png"><img alt="../_images/05_stylenet_ex.png" class="bg-white mb-1" src="../_images/05_stylenet_ex.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.8 </span><span class="caption-text">stylenet final result</span><a class="headerlink" href="#stylenet-ex-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<section id="id5">
<h3><span class="section-number">21.4.1. </span>Code<a class="headerlink" href="#id5" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># We use two images, an original image and a style image</span>
<span class="c1"># and try to make the original image in the style of the style image.</span>
<span class="c1">#</span>
<span class="c1"># Reference paper:</span>
<span class="c1"># https://arxiv.org/abs/1508.06576</span>
<span class="c1">#</span>
<span class="c1"># Need to download the model &#39;imagenet-vgg-verydee-19.mat&#39; from:</span>
<span class="c1">#   http://www.vlfeat.org/matconvnet/models/beta16/imagenet-vgg-verydeep-19.mat</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>
<span class="kn">import</span> <span class="nn">scipy.misc</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="n">ops</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>

<span class="c1"># Image Files</span>
<span class="n">original_image_file</span> <span class="o">=</span> <span class="s1">&#39;images/book_cover.jpg&#39;</span>
<span class="n">style_image_file</span> <span class="o">=</span> <span class="s1">&#39;images/starry_night.jpg&#39;</span>

<span class="c1"># Saved VGG Network path under the current project dir.</span>
<span class="n">vgg_path</span> <span class="o">=</span> <span class="s1">&#39;imagenet-vgg-verydeep-19.mat&#39;</span>

<span class="c1"># Default Arguments</span>
<span class="n">original_image_weight</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">style_image_weight</span> <span class="o">=</span> <span class="mf">500.0</span>
<span class="n">regularization_weight</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">generations</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">output_generations</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">beta1</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">beta2</span> <span class="o">=</span> <span class="mf">0.999</span>

<span class="c1"># Read in images</span>
<span class="n">original_image</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">original_image_file</span><span class="p">)</span>
<span class="n">style_image</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">style_image_file</span><span class="p">)</span>

<span class="c1"># Get shape of target and make the style image the same</span>
<span class="n">target_shape</span> <span class="o">=</span> <span class="n">original_image</span><span class="o">.</span><span class="n">shape</span>
<span class="n">style_image</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">style_image</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>

<span class="c1"># VGG-19 Layer Setup</span>
<span class="c1"># From paper</span>
<span class="n">vgg_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conv1_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu1_1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv1_2&#39;</span><span class="p">,</span> <span class="s1">&#39;relu1_2&#39;</span><span class="p">,</span> <span class="s1">&#39;pool1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv2_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu2_1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv2_2&#39;</span><span class="p">,</span> <span class="s1">&#39;relu2_2&#39;</span><span class="p">,</span> <span class="s1">&#39;pool2&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv3_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu3_1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv3_2&#39;</span><span class="p">,</span> <span class="s1">&#39;relu3_2&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv3_3&#39;</span><span class="p">,</span> <span class="s1">&#39;relu3_3&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv3_4&#39;</span><span class="p">,</span> <span class="s1">&#39;relu3_4&#39;</span><span class="p">,</span> <span class="s1">&#39;pool3&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv4_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu4_1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv4_2&#39;</span><span class="p">,</span> <span class="s1">&#39;relu4_2&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv4_3&#39;</span><span class="p">,</span> <span class="s1">&#39;relu4_3&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv4_4&#39;</span><span class="p">,</span> <span class="s1">&#39;relu4_4&#39;</span><span class="p">,</span> <span class="s1">&#39;pool4&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv5_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu5_1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv5_2&#39;</span><span class="p">,</span> <span class="s1">&#39;relu5_2&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv5_3&#39;</span><span class="p">,</span> <span class="s1">&#39;relu5_3&#39;</span><span class="p">,</span>
              <span class="s1">&#39;conv5_4&#39;</span><span class="p">,</span> <span class="s1">&#39;relu5_4&#39;</span><span class="p">]</span>


<span class="c1"># Extract weights and matrix means</span>
<span class="k">def</span> <span class="nf">extract_net_info</span><span class="p">(</span><span class="n">path_to_params</span><span class="p">):</span>
    <span class="n">vgg_data</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">path_to_params</span><span class="p">)</span>
    <span class="n">normalization_matrix</span> <span class="o">=</span> <span class="n">vgg_data</span><span class="p">[</span><span class="s1">&#39;normalization&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mat_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">normalization_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">network_weights</span> <span class="o">=</span> <span class="n">vgg_data</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mat_mean</span><span class="p">,</span> <span class="n">network_weights</span>
    

<span class="c1"># Create the VGG-19 Network</span>
<span class="k">def</span> <span class="nf">vgg_network</span><span class="p">(</span><span class="n">network_weights</span><span class="p">,</span> <span class="n">init_image</span><span class="p">):</span>
    <span class="n">network</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">init_image</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vgg_layers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">weights</span><span class="p">,</span> <span class="n">bias</span> <span class="o">=</span> <span class="n">network_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">bias</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;SAME&#39;</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pooling</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;SAME&#39;</span><span class="p">)</span>
        <span class="n">network</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
    <span class="k">return</span> <span class="n">network</span>

<span class="c1"># Here we define which layers apply to the original or style image</span>
<span class="n">original_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;relu4_2&#39;</span><span class="p">,</span> <span class="s1">&#39;relu5_2&#39;</span><span class="p">]</span>
<span class="n">style_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;relu1_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu2_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu3_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu4_1&#39;</span><span class="p">,</span> <span class="s1">&#39;relu5_1&#39;</span><span class="p">]</span>

<span class="c1"># Get network parameters</span>
<span class="n">normalization_mean</span><span class="p">,</span> <span class="n">network_weights</span> <span class="o">=</span> <span class="n">extract_net_info</span><span class="p">(</span><span class="n">vgg_path</span><span class="p">)</span>

<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">original_image</span><span class="o">.</span><span class="n">shape</span>
<span class="n">style_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">style_image</span><span class="o">.</span><span class="n">shape</span>
<span class="n">original_features</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">style_features</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Set style weights</span>
<span class="n">style_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">style_layers</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">style_layers</span><span class="p">}</span>

<span class="c1"># Computer feature layers with original image</span>
<span class="n">g_original</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<span class="k">with</span> <span class="n">g_original</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess1</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">vgg_net</span> <span class="o">=</span> <span class="n">vgg_network</span><span class="p">(</span><span class="n">network_weights</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="n">original_minus_mean</span> <span class="o">=</span> <span class="n">original_image</span> <span class="o">-</span> <span class="n">normalization_mean</span>
    <span class="n">original_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">original_minus_mean</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">original_layers</span><span class="p">:</span>
        <span class="n">original_features</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">vgg_net</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">image</span><span class="p">:</span> <span class="n">original_norm</span><span class="p">})</span>

<span class="c1"># Get style image network</span>
<span class="n">g_style</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<span class="k">with</span> <span class="n">g_style</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess2</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">style_shape</span><span class="p">)</span>
    <span class="n">vgg_net</span> <span class="o">=</span> <span class="n">vgg_network</span><span class="p">(</span><span class="n">network_weights</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="n">style_minus_mean</span> <span class="o">=</span> <span class="n">style_image</span> <span class="o">-</span> <span class="n">normalization_mean</span>
    <span class="n">style_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">style_minus_mean</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">style_layers</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg_net</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">image</span><span class="p">:</span> <span class="n">style_norm</span><span class="p">})</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">gram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span> <span class="o">/</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span>
        <span class="n">style_features</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">gram</span>

<span class="c1"># Make Combined Image via loss function</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="c1"># Get network parameters</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.256</span>
    <span class="n">init_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
    <span class="n">vgg_net</span> <span class="o">=</span> <span class="n">vgg_network</span><span class="p">(</span><span class="n">network_weights</span><span class="p">,</span> <span class="n">init_image</span><span class="p">)</span>

    <span class="c1"># Loss from Original Image</span>
    <span class="n">original_layers_w</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;relu4_2&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;relu5_2&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
    <span class="n">original_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">o_layer</span> <span class="ow">in</span> <span class="n">original_layers</span><span class="p">:</span>
        <span class="n">temp_original_loss</span> <span class="o">=</span> <span class="n">original_layers_w</span><span class="p">[</span><span class="n">o_layer</span><span class="p">]</span> <span class="o">*</span> <span class="n">original_image_weight</span> <span class="o">*</span>\
                             <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">l2_loss</span><span class="p">(</span><span class="n">vgg_net</span><span class="p">[</span><span class="n">o_layer</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_features</span><span class="p">[</span><span class="n">o_layer</span><span class="p">]))</span>
        <span class="n">original_loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">temp_original_loss</span> <span class="o">/</span> <span class="n">original_features</span><span class="p">[</span><span class="n">o_layer</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="c1"># Loss from Style Image</span>
    <span class="n">style_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">style_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">style_layer</span> <span class="ow">in</span> <span class="n">style_layers</span><span class="p">:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">vgg_net</span><span class="p">[</span><span class="n">style_layer</span><span class="p">]</span>
        <span class="n">feats</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">channels</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="p">))</span>
        <span class="n">style_gram_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">features</span><span class="p">),</span> <span class="n">features</span><span class="p">)</span> <span class="o">/</span> <span class="n">size</span>
        <span class="n">style_expected</span> <span class="o">=</span> <span class="n">style_features</span><span class="p">[</span><span class="n">style_layer</span><span class="p">]</span>
        <span class="n">style_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">style_weights</span><span class="p">[</span><span class="n">style_layer</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span>
                            <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">l2_loss</span><span class="p">(</span><span class="n">style_gram_matrix</span> <span class="o">-</span> <span class="n">style_expected</span><span class="p">)</span> <span class="o">/</span>
                            <span class="n">style_expected</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">style_loss</span> <span class="o">+=</span> <span class="n">style_image_weight</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">style_losses</span><span class="p">)</span>

    <span class="c1"># To Smooth the results, we add in total variation loss</span>
    <span class="n">total_var_x</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">init_image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span><span class="o">.</span><span class="n">as_list</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var_y</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">init_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span><span class="o">.</span><span class="n">as_list</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">first_term</span> <span class="o">=</span> <span class="n">regularization_weight</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">second_term_numerator</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">l2_loss</span><span class="p">(</span><span class="n">init_image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">init_image</span><span class="p">[:,</span> <span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
    <span class="n">second_term</span> <span class="o">=</span> <span class="n">second_term_numerator</span> <span class="o">/</span> <span class="n">total_var_y</span>
    <span class="n">third_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">l2_loss</span><span class="p">(</span><span class="n">init_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">init_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">total_var_x</span><span class="p">)</span>
    <span class="n">total_variation_loss</span> <span class="o">=</span> <span class="n">first_term</span> <span class="o">*</span> <span class="p">(</span><span class="n">second_term</span> <span class="o">+</span> <span class="n">third_term</span><span class="p">)</span>

    <span class="c1"># Combined Loss</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">original_loss</span> <span class="o">+</span> <span class="n">style_loss</span> <span class="o">+</span> <span class="n">total_variation_loss</span>

    <span class="c1"># Declare Optimization Algorithm</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">)</span>
    <span class="n">train_step</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

    <span class="c1"># Initialize variables and start training</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">generations</span><span class="p">):</span>

            <span class="n">train_step</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="c1"># Print update and save temporary output</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">output_generations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generation </span><span class="si">{}</span><span class="s1"> out of </span><span class="si">{}</span><span class="s1">, loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">generations</span><span class="p">,</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss</span><span class="p">)))</span>
                <span class="n">image_eval</span> <span class="o">=</span> <span class="n">init_image</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="n">best_image_add_mean</span> <span class="o">=</span> <span class="n">image_eval</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="n">normalization_mean</span>
                <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;temp_output_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">imageio</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">best_image_add_mean</span><span class="p">)</span>
        
        
        <span class="c1"># Save final image</span>
        <span class="n">image_eval</span> <span class="o">=</span> <span class="n">init_image</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">best_image_add_mean</span> <span class="o">=</span> <span class="n">image_eval</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="n">normalization_mean</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;final_output.jpg&#39;</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">best_image_add_mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="deepdream-in-tensorflow">
<h2><span class="section-number">21.5. </span>Deepdream in TensorFlow<a class="headerlink" href="#deepdream-in-tensorflow" title="Permalink to this headline">#</a></h2>
<p>Note: There is no new code in this script. It originates from the TensorFlow tutorial located here. However, this code is modified slightly to run on Python 3. The code is also commented very heavily to explain, line-by-line, what occurs in the deepdream demo.</p>
<p>Here are some potential outputs.</p>
<figure class="align-default" id="deepdream-ex-dl">
<a class="bg-white mb-1 reference internal image-reference" href="../_images/06_deepdream_ex.png"><img alt="../_images/06_deepdream_ex.png" class="bg-white mb-1" src="../_images/06_deepdream_ex.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21.9 </span><span class="caption-text">Deepdream outputs</span><a class="headerlink" href="#deepdream-ex-dl" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<section id="id6">
<h3><span class="section-number">21.5.1. </span>Code<a class="headerlink" href="#id6" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using TensorFlow for Deep Dream</span>
<span class="c1">#---------------------------------------</span>
<span class="c1"># From: Alexander Mordvintsev</span>
<span class="c1">#      --https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/tutorials/deepdream</span>
<span class="c1">#</span>
<span class="c1"># Make sure to download the deep dream model here:</span>
<span class="c1">#   https://storage.googleapis.com/download.tensorflow.org/models/inception5h.zip</span>
<span class="c1">#</span>
<span class="c1"># Run:</span>
<span class="c1">#  me@computer:~$ wget https://storage.googleapis.com/download.tensorflow.org/models/inception5h.zip </span>
<span class="c1">#  me@computer:~$ unzip inception5h.zip</span>
<span class="c1">#</span>
<span class="c1">#  More comments added inline.</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">PIL.Image</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="n">ops</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>

<span class="c1"># Start a graph session</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">InteractiveSession</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;~/Documents/tensorflow/inception-v1-model/&#39;</span><span class="p">)</span>

<span class="c1"># Model filename</span>
<span class="n">model_fn</span> <span class="o">=</span> <span class="s1">&#39;tensorflow_inception_graph.pb&#39;</span>

<span class="c1"># Load graph parameters</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">FastGFile</span><span class="p">(</span><span class="n">model_fn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">graph_def</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GraphDef</span><span class="p">()</span>
    <span class="n">graph_def</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># Create placeholder for input</span>
<span class="n">t_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">)</span>

<span class="c1"># Imagenet average bias to subtract off images</span>
<span class="n">imagenet_mean</span> <span class="o">=</span> <span class="mf">117.0</span>
<span class="n">t_preprocessed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">t_input</span><span class="o">-</span><span class="n">imagenet_mean</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">import_graph_def</span><span class="p">(</span><span class="n">graph_def</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;input&#39;</span><span class="p">:</span><span class="n">t_preprocessed</span><span class="p">})</span>

<span class="c1"># Create a list of layers that we can refer to later</span>
<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()</span> <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;Conv2D&#39;</span> <span class="ow">and</span> <span class="s1">&#39;import/&#39;</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

<span class="c1"># Count how many outputs for each layer</span>
<span class="n">feature_nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;:0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]</span>

<span class="c1"># Print count of layers and outputs (features nodes)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of layers&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of feature channels:&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_nums</span><span class="p">))</span>

<span class="c1"># Picking some internal layer. Note that we use outputs before applying the ReLU nonlinearity</span>
<span class="c1"># to have non-zero gradients for features with negative initial activations.</span>
<span class="n">layer</span> <span class="o">=</span> <span class="s1">&#39;mixed4d_3x3_bottleneck_pre_relu&#39;</span>
<span class="n">channel</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># picking some feature channel to visualize</span>

<span class="c1"># start with a gray image with a little noise</span>
<span class="n">img_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="mf">100.0</span>

<span class="k">def</span> <span class="nf">showarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;jpeg&#39;</span><span class="p">):</span>
    <span class="c1"># First make sure everything is between 0 and 255</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
    <span class="c1"># Pick an in-memory format for image display</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="c1"># Create the in memory image</span>
    <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="c1"># Show image</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">T</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Helper for getting layer output tensor&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s2">&quot;import/</span><span class="si">%s</span><span class="s2">:0&quot;</span><span class="o">%</span><span class="n">layer</span><span class="p">)</span>


<span class="c1"># The following function returns a function wrapper that will create the placeholder</span>
<span class="c1"># inputs of a specified dtype</span>
<span class="k">def</span> <span class="nf">tffunc</span><span class="p">(</span><span class="o">*</span><span class="n">argtypes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Helper that transforms TF-graph generating function into a regular one.</span>
<span class="sd">    See &quot;resize&quot; function below.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">placeholders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">,</span> <span class="n">argtypes</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">placeholders</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">placeholders</span><span class="p">,</span> <span class="n">args</span><span class="p">)),</span> <span class="n">session</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">wrap</span>


<span class="c1"># Helper function that uses TF to resize an image</span>
<span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Change &#39;img&#39; size by linear interpolation</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_bilinear</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">size</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>


<span class="k">def</span> <span class="nf">calc_grad_tiled</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">t_grad</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Compute the value of tensor t_grad over the image in a tiled way.</span>
<span class="sd">    Random shifts are applied to the image to blur tile boundaries over </span>
<span class="sd">    multiple iterations.&#39;&#39;&#39;</span>
    <span class="c1"># Pick a subregion square size</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="n">tile_size</span>
    <span class="c1"># Get the image height and width</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Get a random shift amount in the x and y direction</span>
    <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Randomly shift the image (roll image) in the x and y directions</span>
    <span class="n">img_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sy</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Initialize the while image gradient as zeros</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="c1"># Now we loop through all the sub-tiles in the image</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="n">sz</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">sz</span><span class="p">),</span><span class="n">sz</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="n">sz</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">sz</span><span class="p">),</span><span class="n">sz</span><span class="p">):</span>
            <span class="c1"># Select the sub image tile</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">img_shift</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">sz</span><span class="p">,</span><span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">sz</span><span class="p">]</span>
            <span class="c1"># Calculate the gradient for the tile</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t_grad</span><span class="p">,</span> <span class="p">{</span><span class="n">t_input</span><span class="p">:</span><span class="n">sub</span><span class="p">})</span>
            <span class="c1"># Apply the gradient of the tile to the whole image gradient</span>
            <span class="n">grad</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">sz</span><span class="p">,</span><span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
    <span class="c1"># Return the gradient, undoing the roll operation</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="o">-</span><span class="n">sx</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">sy</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">render_deepdream</span><span class="p">(</span><span class="n">t_obj</span><span class="p">,</span> <span class="n">img0</span><span class="o">=</span><span class="n">img_noise</span><span class="p">,</span>
                     <span class="n">iter_n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">octave_n</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">octave_scale</span><span class="o">=</span><span class="mf">1.4</span><span class="p">):</span>
    <span class="c1"># defining the optimization objective, the objective is the mean of the feature</span>
    <span class="n">t_score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">t_obj</span><span class="p">)</span>
    <span class="c1"># Our gradients will be defined as changing the t_input to get closer to</span>
    <span class="c1"># the values of t_score.  Here, t_score is the mean of the feature we select,</span>
    <span class="c1"># and t_input will be the image octave (starting with the last)</span>
    <span class="n">t_grad</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gradients</span><span class="p">(</span><span class="n">t_score</span><span class="p">,</span> <span class="n">t_input</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># behold the power of automatic differentiation!</span>

    <span class="c1"># Store the image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img0</span>
    <span class="c1"># Initialize the octave list</span>
    <span class="n">octaves</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Since we stored the image, we need to only calculate n-1 octaves</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">octave_n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Extract the image shape</span>
        <span class="n">hw</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Resize the image, scale by the octave_scale (resize by linear interpolation)</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span><span class="o">/</span><span class="n">octave_scale</span><span class="p">))</span>
        <span class="c1"># Residual is hi.  Where residual = image - (Resize lo to be hw-shape)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">img</span><span class="o">-</span><span class="n">resize</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span>
        <span class="c1"># Save the lo image for re-iterating</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">lo</span>
        <span class="c1"># Save the extracted hi-image</span>
        <span class="n">octaves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hi</span><span class="p">)</span>
    
    <span class="c1"># generate details octave by octave</span>
    <span class="k">for</span> <span class="n">octave</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">octave_n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">octave</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Start with the last octave</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">octaves</span><span class="p">[</span><span class="o">-</span><span class="n">octave</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">hi</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="n">hi</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iter_n</span><span class="p">):</span>
            <span class="c1"># Calculate gradient of the image.</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">calc_grad_tiled</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">t_grad</span><span class="p">)</span>
            <span class="c1"># Ideally, we would just add the gradient, g, but</span>
            <span class="c1"># we want do a forward step size of it (&#39;step&#39;),</span>
            <span class="c1"># and divide it by the avg. norm of the gradient, so</span>
            <span class="c1"># we are adding a gradient of a certain size each step.</span>
            <span class="c1"># Also, to make sure we aren&#39;t dividing by zero, we add 1e-7.</span>
            <span class="n">img</span> <span class="o">+=</span> <span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="n">step</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mf">1e-7</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">showarray</span><span class="p">(</span><span class="n">img</span><span class="o">/</span><span class="mf">255.0</span><span class="p">)</span>

<span class="c1"># Run Deep Dream</span>
<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Create resize function that has a wrapper that creates specified placeholder types</span>
    <span class="n">resize</span> <span class="o">=</span> <span class="n">tffunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)(</span><span class="n">resize</span><span class="p">)</span>
    
    <span class="c1"># Open image</span>
    <span class="n">img0</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;book_cover.jpg&#39;</span><span class="p">)</span>
    <span class="n">img0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">img0</span><span class="p">)</span>
    <span class="c1"># Show Original Image</span>
    <span class="n">showarray</span><span class="p">(</span><span class="n">img0</span><span class="o">/</span><span class="mf">255.0</span><span class="p">)</span>

    <span class="c1"># Create deep dream</span>
    <span class="n">render_deepdream</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">layer</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">],</span> <span class="n">img0</span><span class="p">,</span> <span class="n">iter_n</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="your-turn">
<h2><span class="section-number">21.6. </span>Your turn! 🚀<a class="headerlink" href="#your-turn" title="Permalink to this headline">#</a></h2>
<p>TBD.</p>
</section>
<section id="self-study">
<h2><span class="section-number">21.7. </span>Self study<a class="headerlink" href="#self-study" title="Permalink to this headline">#</a></h2>
<p>You can refer to those YouTube videos for further study:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=YRhxdVk_sIs">Convolutional Neural Networks (CNNs) explained, by deeplizard</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=pj9-rr1wDhM">Convolutional Neural Networks Explained (CNN Visualized), by Futurology</a></p></li>
</ul>
<section id="research-trend">
<h3><span class="section-number">21.7.1. </span>Research trend<a class="headerlink" href="#research-trend" title="Permalink to this headline">#</a></h3>
<p>State of the Art Convolutional Neural Networks (CNNs) Explained | Deep Learning in 2020:</p>
<div class="yt-container">
   <iframe src="https://www.youtube.com/embed/YUyec4eCEiY" allowfullscreen></iframe>
</div>
</section>
</section>
<section id="acknowledgments">
<h2><span class="section-number">21.8. </span>Acknowledgments<a class="headerlink" href="#acknowledgments" title="Permalink to this headline">#</a></h2>
<p>Thanks to <a class="reference external" href="https://github.com/nfmcclure">Nick</a> for creating the open-source course <a class="reference external" href="https://github.com/nfmcclure/tensorflow_cookbook">tensorflow_cookbook</a>. It inspires the majority of the content in this chapter.</p>
<hr class="docutils" />
<div class="docutils container" id="id7">
<dl class="citation">
<dt class="label" id="id71"><span class="brackets">Wik</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>)</span></dt>
<dd><p>Wikipedia. Rectifier (neural networks). URL: <a class="reference external" href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)/">https://en.wikipedia.org/wiki/Rectifier_(neural_networks)/</a> (visited on 2022).</p>
</dd>
</dl>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "open-academy/machine-learning",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./deep-learning"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="dl-overview.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">20. </span>Deep learning overview (TBD)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="GAN.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">22. </span>Generative adversarial networks</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Ocademy<br/>
  
      &copy; Copyright 2022-2022.<br/>
    <div class="extra_footer">
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a> Text content of this work is licensed under the <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>